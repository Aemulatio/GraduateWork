<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ВКР</title>
    <link rel="stylesheet" href="../static/css/index.css">
    <link rel="icon" type="image/x-icon" href="../static/imgs/favicon.ico">
    <script src="../static/js/Chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap"
          rel="stylesheet">
    <script type="text/javascript" src="../static/js/jquery-3.5.1.min.js"></script>
</head>
<body>
<div class="predict clearfix">
    <div class="predict__container container clearfix">
        <div class="predict__content ">
            <form action="/" method="post" class="predict__form clearfix" id="predict__form" name="prediction__form">
                <!--КОМАНДА-1-->
                <div class="predict__element clearfix">
                    <h2 class="clearfix">
                        <span>Команда 1</span>
                    </h2>
                    <div class="predict__selector">
                        <select name="team1" id="team1" class="predict__select" onchange="teamOne()"
                                required>
                            <option selected disabled value="">Выберите команду</option>
                            {%for team in teams%}
                            <option value="{{team}}">{{team}}</option>
                            {%endfor%}
                        </select>
                    </div>
                    <div class="predict__selected-team-logo">
                        <img src="" alt="" class="predict__team1-logo predict__team-logo">
                    </div>
                </div>
                <!--КОМАНДА-2-->
                <div class="predict__element clearfix">
                    <h2 class="clearfix">
                        <span >Команда 2</span>
                    </h2>
                    <div class="predict__selector">
                        <select name="team2" id="team2" class="predict__select" onchange="teamTwo()" required>
                            <option selected disabled value="">Выберите команду</option>
                            {%for team in teams%}
                            <option value="{{team}}">{{team}}</option>
                            {%endfor%}
                        </select>
                    </div>
                    <div class="predict__selected-team-logo">
                        <img src="" alt="" class="predict__team2-logo predict__team-logo">
                    </div>
                </div>
                <!--КАРТА-->
                <div class="predict__element clearfix">
                    <h2 class="clearfix">
                        <span >Карта</span>
                    </h2>
                    <div class="predict__selector">
                        <select name="map" id="map" class="predict__select " onchange="map_logo()" required>
                            <option selected disabled value="">Выберите карту</option>
                            {%for map in maps%}
                            <option value="{{map}}" class="predict__select">{{map}}</option>
                            {%endfor%}
                        </select>
                    </div>
                    <div class="predict__selected-map-logo">
                        <img src="" alt="" id="predict__map-logo" class="predict__map-logo">
                    </div>
                </div>
                <!--SUBMIT-->
                <input type="submit" class="predict__submit">
            </form>
        </div>
    </div>
</div>
{%if winner%}
<div class="result">
    <div class="result__container container">
        <div class="result__content clearfix">
            <h2 class="result__entered-data-title">Вы ввели:</h2>
            <div class="result__entered-data clearfix">
                <div class="result__entered-data-teams">
                    <div class="result__team1 result__block">
                        <img src="../static/imgs/logos/{{team1}}.png" alt="{{team1}}" class="result__team-logo">
                        <h3>{{team1}}</h3>
                    </div>
                    <div class="result__line"></div>
                    <div class="result__team2 result__block">
                        <img src="../static/imgs/logos/{{team2}}.png" alt="{{team2}}" class="result__team-logo">
                        <h3>{{team2}}</h3>
                    </div>
                </div>
            </div>
            <div class="result__entered-data clearfix">
                <div class="result__map">
                    <img src="../static/imgs/map_logos/{{map}}.png" alt="{{map}}" class="result__team-logo">
                    <h3>{{map}}</h3>
                </div>
            </div>
            <h2 class="result__entered-data-title result__winner-title">Победитель:</h2>
            <div class="result__winner">
                <img src="../static/imgs/logos/{{winner}}.png" alt="{{winner}}"
                     class="result__team-logo" title="{{winner}}">
                <h3>{{winner}}</h3>
            </div>
        </div>
    </div>
</div>

<div class="choose-graph-style">
    <div class="choose-graph-style__container container">
        <h2>Выберите вид гистограммы:</h2>
        <div class="choose-graph-style__box">
            <input type="radio" id="common" name="radio" checked onchange="change()">
            <label for="common">Обычный вид</label>

            <input type="radio" id="stacked" name="radio" onchange="change()">
            <label for="stacked">Вложеная гистограмма</label>
        </div>
    </div>
</div>

<div class="graphs">
    <div class="graphs__container container">
        <div class="graphs__content">
            <div class="graphs__team1">
                <canvas id="team1__graph"></canvas>
            </div>
            <div class="graphs__team2">
                <canvas id="team2__graph"></canvas>
            </div>
        </div>
    </div>
</div>

<script title="Graphs" type="text/javascript">

    function build(team, canvasID) {
        let path_matches = '../static/jsons/' + team + '_matches.json';
        let path__wins = '../static/jsons/' + team + '_wins.json';
        let request_m = new XMLHttpRequest();
        request_m.open('GET', path_matches);
        request_m.responseType = 'json';
        request_m.send();
        request_m.onload = function () {
            let request_w = new XMLHttpRequest();
            request_w.open('GET', path__wins);
            request_w.responseType = 'json';
            request_w.send();
            request_w.onload = function () {
                let matchesJSON_unordered = request_m.response;
                let winsJSON_unordered = request_w.response;
                //матчи
                const matchesJSON = {};
                Object.keys(matchesJSON_unordered).sort().forEach(function (key) {
                    matchesJSON[key] = matchesJSON_unordered[key];
                });
                //победы
                const winsJSON = {};
                Object.keys(winsJSON_unordered).sort().forEach(function (key) {
                    winsJSON[key] = winsJSON_unordered[key];
                });
                let matches = Object.values(matchesJSON);
                let wins = Object.values(winsJSON);
                let stacked = document.getElementById('stacked').checked

                var ctx = document.getElementById(canvasID).getContext('2d');
                var myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(matchesJSON),
                        datasets: [
                            {
                                label: 'Количество побед команды ' + team,
                                backgroundColor: 'rgba(65, 105, 225, 1)',
                                data: wins,
                            },
                            {
                                label: 'Количество матчей команды ' + team,
                                backgroundColor: 'rgba(255, 99, 132, 1)',
                                data: matches,
                            },]
                    },
                    options: {
                        scales: {
                            xAxes: [{
                                stacked: stacked,
                                gridLines: {
                                    color: '#fffff0',
                                },
                                ticks: {
                                    fontColor: '#ffffff'
                                }
                            }],
                            yAxes: [{
                                stacked: false,
                                ticks: {
                                    fontColor: '#ffffff'
                                },
                                gridLines: {
                                    color: '#fffff0',
                                },

                            }],
                        },
                        legend: {
                            labels: {
                                fontColor: '#ffffff'
                            }
                        }
                    }
                });
            }
        }
    }

    function change() {
        // $('#team1__graph').attr('id', 'team1__graph1')
        $('#team1__graph').remove();
        $('.graphs__team1').append('<canvas id="team1__graph"><canvas>');

        // $('#team2__graph').attr('id', 'team2__graph2')
        $('#team2__graph').remove();
        $('.graphs__team2').append('<canvas id="team2__graph"><canvas>');

        build('{{team1}}', 'team1__graph');
        build('{{team2}}', 'team2__graph');
    }

    window.onresize = function (event) {
        // $('#team1__graph').attr('id', 'team1__graph1')
        $('#team1__graph').remove();
        $('.graphs__team1').append('<canvas id="team1__graph"><canvas>');

        // $('#team2__graph').attr('id', 'team2__graph2')
        $('#team2__graph').remove();
        $('.graphs__team2').append('<canvas id="team2__graph"><canvas>');

        build('{{team1}}', 'team1__graph');
        build('{{team2}}', 'team2__graph');
    };

    build('{{team1}}', 'team1__graph');
    build('{{team2}}', 'team2__graph');
</script>
{%endif%}
<script type="text/javascript">

    function teamOne() {
        let team1 = document.getElementById('team1')
        let team1Image = document.querySelector('.predict__team1-logo')
        team1Image.setAttribute('src', '../static/imgs/logos/' + team1.options[team1.selectedIndex].value + '.png')
        team1Image.setAttribute('alt', team1.options[team1.selectedIndex].value)
        team1Image.setAttribute('title', team1.options[team1.selectedIndex].value)

    }

    function teamTwo() {
        let team2 = document.getElementById('team2')
        let team2Image = document.querySelector('.predict__team2-logo')
        team2Image.setAttribute('src', '../static/imgs/logos/' + team2.options[team2.selectedIndex].value + '.png')
        team2Image.setAttribute('alt', team2.options[team2.selectedIndex].value)
        team2Image.setAttribute('title', team2.options[team2.selectedIndex].value)

    }

    function map_logo() {
        let map_name = document.getElementById('map');
        let mapImage = document.querySelector('#predict__map-logo');
        mapImage.setAttribute('src', '../static/imgs/map_logos/' + map_name.options[map_name.selectedIndex].value + '.png')
        mapImage.setAttribute('alt', map_name.options[map_name.selectedIndex].value)
        mapImage.setAttribute('title', map_name.options[map_name.selectedIndex].value)
    }

    $('#predict__form').submit(function () {
        let team1 = document.getElementById('team1')
        let team2 = document.getElementById('team2')
        let map_name = document.getElementById('map');

        if (team1.options[team1.selectedIndex].value === '-1' || team2.options[team2.selectedIndex].value === '-1' || map_name.options[map_name.selectedIndex].value === '-1') {
            alert('Выберите пожалуйста команды и карту.');
            return false;
        }

        if (team1.options[team1.selectedIndex].value !== team2.options[team2.selectedIndex].value)
            return true;
        else {
            alert('Выберите разные команды!');
            return false;
        }


    });


</script>
</body>
</html>