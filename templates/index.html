<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ВКР</title>
    <link rel="stylesheet" href="../static/css/index.css">
    <link rel="icon" type="image/x-icon" href="../static/imgs/favicon.ico">
    <!--    <script src="../static/js/d3.min.js"></script>-->
    <script src="../static/js/Chart.min.js"></script>
    <!--    <script href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>-->
</head>
<body>
<div class="predict clearfix">
    <div class="predict__container container clearfix">
        <div class="predict__content ">
            <form action="" method="post" class="predict__form" name="prediction_form">
                <!--КОМАНДА-1-->
                <div class="predict__element">
                    <h2>
                        <label for="team1">Команда 1</label>
                    </h2>
                    <select name="team1" id="team1" class="predict__select" onchange="teamOne()" required>
                        <option value="" class="predict__select">Выберите команду</option>
                        {%for team in teams%}
                        <option value="{{team}}" class="predict__select">{{team}}</option>
                        {%endfor%}
                    </select>
                    <img src="" alt="" class="predict__team1-logo predict__team-logo">
                </div>
                <!--КОМАНДА-2-->
                <div class="predict__element">
                    <h2>
                        <label for="team2">Команда 2</label>
                    </h2>
                    <select name="team2" id="team2" class="predict__select" onchange="teamTwo()" required>
                        <option value="" class="predict__select">Выберите команду</option>
                        {%for team in teams%}
                        <option value="{{team}}" class="predict__select">{{team}}</option>
                        {%endfor%}
                    </select>
                    <img src="" alt="" class="predict__team2-logo predict__team-logo">
                </div>
                <!--КАРТА-->
                <div class="predict__element">
                    <h2>
                        <label for="map">Карта</label>
                    </h2>
                    <select name="map" id="map" class="predict__select" required>
                        <option value="" class="predict__select">Выберите карту</option>
                        {%for map in maps%}
                        <option value="{{map}}" class="predict__select">{{map}}</option>
                        {%endfor%}
                    </select>
                </div>
                <!--SUBMIT-->
                <p>
                    <input type="submit">
                </p>
            </form>
        </div>
    </div>
</div>
{%if winner%}

<div class="result">
    <div class="result__container container">
        <div class="result__content">
            <div class="result__team1">

            </div>
            <div class="result__team2">

            </div>
            <div class="result__winner">
                <h3>{{winner}}</h3>
                <img src="../static/imgs/logos/{{winner}}.png" alt="{{winner}}"
                     class="result__team-logo" title="{{winner}}">
            </div>
        </div>
    </div>
</div>

<form action="">
    <label for="stacked">Вложеная гистограмма</label>
    <input type="radio" id="stacked" name="radio" onchange="change()">
    <label for="common">Обычный вид</label>
    <input type="radio" id="common" name="radio" checked onchange="change()">
</form>


<div class="graphs">
    <div class="graphs__container container">
        <div class="graphs__content">
            <div class="graphs__team1">
                <canvas id="team1__graph"></canvas>
            </div>
            <div class="graphs__team2">
                <canvas id="team2__graph"></canvas>

            </div>
        </div>
    </div>
</div>
{%endif%}

<script type="text/javascript" src="../static/js/jquery-3.5.1.min.js"></script>


<script type="text/javascript">
    function teamOne() {
        team1 = document.getElementById('team1')
        team1Image = document.querySelector('.predict__team1-logo')
        team1Image.setAttribute('src', '../static/imgs/logos/' + team1.options[team1.selectedIndex].value + '.png')
        team1Image.setAttribute('alt', team1.options[team1.selectedIndex].value)
        team1Image.setAttribute('title', team1.options[team1.selectedIndex].value)
    }

    function teamTwo() {
        team2 = document.getElementById('team2')
        team2Image = document.querySelector('.predict__team2-logo')
        team2Image.setAttribute('src', '../static/imgs/logos/' + team2.options[team2.selectedIndex].value + '.png')
        team2Image.setAttribute('alt', team2.options[team2.selectedIndex].value)
        team2Image.setAttribute('title', team2.options[team2.selectedIndex].value)

    }
</script>

<script type="text/javascript">

    function build(team, canvasID) {

        //TEAM1
        let path_matches = '../static/jsons/' + team + '_matches.json';
        let path__wins = '../static/jsons/' + team + '_wins.json';
        let request_m = new XMLHttpRequest();

        request_m.open('GET', path_matches);
        request_m.responseType = 'json';
        request_m.send();
        request_m.onload = function () {
            let request_w = new XMLHttpRequest();
            request_w.open('GET', path__wins);
            request_w.responseType = 'json';
            request_w.send();
            request_w.onload = function () {
                let matchesJSON_unordered = request_m.response;
                let winsJSON_unordered = request_w.response;

                //матчи
                const matchesJSON = {};
                Object.keys(matchesJSON_unordered).sort().forEach(function (key) {
                    matchesJSON[key] = matchesJSON_unordered[key];
                });
                //победы
                const winsJSON = {};
                Object.keys(winsJSON_unordered).sort().forEach(function (key) {
                    winsJSON[key] = winsJSON_unordered[key];
                });

                console.log(matchesJSON);
                console.log(winsJSON);

                let matches = Object.values(matchesJSON);
                let wins = Object.values(winsJSON);

                let stacked = document.getElementById('stacked').checked

                var ctx = document.getElementById(canvasID).getContext('2d');
                console.log(document.getElementById(canvasID));
                var myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(matchesJSON),
                        datasets: [
                            {
                                label: 'Количество побед команды {{team1}}',
                                backgroundColor: 'rgba(65, 105, 225, 1)',
                                data: wins,
                            },
                            {
                                label: 'Количество матчей команды {{team1}}',
                                backgroundColor: 'rgba(255, 99, 132, 1)',
                                data: matches,
                            },

                        ]
                    },
                    options: {
                        scales: {
                            xAxes: [{
                                stacked: stacked
                            }],
                            yAxes: [{
                                stacked: false,
                                ticks: {
                                    beginAtZero: true
                                }
                            }]
                        }
                    }
                });
            }
        }
    }


    function change() {
        $('#team1__graph').remove();
        $('.graphs__team1').append('<canvas id="team1__graph"><canvas>');

        $('#team2__graph').remove();
        $('.graphs__team2').append('<canvas id="team2__graph"><canvas>');


        build('{{team1}}', 'team1__graph');
        build('{{team2}}', 'team2__graph');
    }

    build('{{team1}}', 'team1__graph');
    build('{{team2}}', 'team2__graph');
</script>
</body>
</html>